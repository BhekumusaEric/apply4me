# Apply4Me CI/CD Pipeline Guide

## üöÄ Overview

The Apply4Me CI/CD pipeline provides automated testing, building, and deployment for both web and mobile applications using GitHub Actions, Vercel, and Expo/EAS.

## üìã Pipeline Structure

### Workflow Triggers
- **Push to `main`**: Triggers production deployment
- **Push to `develop`**: Triggers staging deployment  
- **Pull Request to `main`**: Triggers testing and validation

### Pipeline Jobs

#### 1. üß™ Test Web Application (`test-web`)
- **Purpose**: Validates web application code quality and functionality
- **Steps**:
  - Checkout code
  - Setup Node.js 18
  - Install dependencies with `npm ci`
  - Run ESLint for code quality
  - Build application with production environment variables
  - Run tests (with `--passWithNoTests` for projects without tests)
  - Upload build artifacts

#### 2. üì± Test Mobile Application (`test-mobile`)
- **Purpose**: Validates mobile application code and build process
- **Steps**:
  - Checkout code
  - Setup Node.js 18 with mobile-specific cache
  - Install Expo CLI globally
  - Install mobile dependencies
  - Run mobile app linting
  - Perform Expo prebuild for Android

#### 3. üöÄ Deploy to Staging (`deploy-staging`)
- **Trigger**: Push to `develop` branch
- **Dependencies**: Requires `test-web` and `test-mobile` to pass
- **Steps**:
  - Setup Vercel CLI
  - Pull preview environment configuration
  - Build project artifacts
  - Deploy to Vercel staging environment

#### 4. üåü Deploy to Production (`deploy-production`)
- **Trigger**: Push to `main` branch
- **Dependencies**: Requires `test-web` and `test-mobile` to pass
- **Steps**:
  - Setup Vercel CLI
  - Pull production environment configuration
  - Build project artifacts with production flag
  - Deploy to Vercel production environment
  - Send success notification

#### 5. üì± Build Android App (`build-mobile-android`)
- **Trigger**: Push to `main` branch
- **Dependencies**: Requires `test-mobile` to pass
- **Steps**:
  - Install Expo CLI and EAS CLI
  - Authenticate with Expo using token
  - Build Android APK using EAS
  - Upload APK as artifact

#### 6. üè• Health Check (`health-check`)
- **Trigger**: After successful production deployment
- **Dependencies**: Requires `deploy-production` to complete
- **Steps**:
  - Check website accessibility (HTTP 200)
  - Verify API health endpoint functionality
  - Validate application is responding correctly

## üîê Required Secrets

### Supabase Configuration
- `NEXT_PUBLIC_SUPABASE_URL`: Your Supabase project URL
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`: Supabase public/anonymous key
- `SUPABASE_SERVICE_ROLE_KEY`: Supabase service role key

### Application Settings
- `NEXT_PUBLIC_APP_URL`: Production application URL
- `NEXT_PUBLIC_YOCO_PUBLIC_KEY`: Yoco payment public key
- `YOCO_SECRET_KEY`: Yoco payment secret key

### Deployment Platforms
- `VERCEL_TOKEN`: Vercel authentication token
- `VERCEL_ORG_ID`: Vercel organization ID
- `VERCEL_PROJECT_ID`: Vercel project ID
- `EXPO_TOKEN`: Expo authentication token

## üåç Environment Strategy

### Production (`main` branch)
- **URL**: https://apply4me-eta.vercel.app
- **Database**: Production Supabase instance
- **Payments**: Live Yoco keys
- **Monitoring**: Full health checks enabled

### Staging (`develop` branch)
- **URL**: Preview deployment URL (generated by Vercel)
- **Database**: Staging Supabase instance (recommended)
- **Payments**: Test Yoco keys
- **Monitoring**: Basic health checks

## üîß Local Development Setup

### Prerequisites
```bash
# Install dependencies
npm install

# Setup environment variables
cp .env.example .env
# Edit .env with your development values
```

### Running Locally
```bash
# Start web development server
npm run dev

# Start mobile development
cd mobile
npm install
npx expo start
```

### Testing Locally
```bash
# Run linting
npm run lint

# Run tests
npm test

# Build for production
npm run build

# Verify deployment
./scripts/verify-deployment.sh http://localhost:3001
```

## üìä Monitoring and Alerts

### Health Checks
- **Endpoint**: `/api/health`
- **Frequency**: After each deployment
- **Checks**: Database connectivity, environment variables, service status

### Build Notifications
- **Success**: Logged to GitHub Actions
- **Failure**: GitHub Actions will show detailed error logs
- **Performance**: Response time monitoring included

## üö® Troubleshooting

### Common Issues

#### Build Failures
```bash
# Check environment variables
echo $NEXT_PUBLIC_SUPABASE_URL

# Verify dependencies
npm ci
npm run build
```

#### Deployment Failures
```bash
# Check Vercel configuration
vercel whoami --token $VERCEL_TOKEN
vercel link

# Verify project settings
vercel env ls
```

#### Mobile Build Issues
```bash
# Check Expo authentication
expo whoami --token $EXPO_TOKEN

# Verify EAS configuration
cd mobile
eas build:list
```

### Debug Steps

1. **Check GitHub Actions logs** for specific error messages
2. **Verify all secrets** are correctly configured
3. **Test locally** using the same environment variables
4. **Check service status** for Vercel, Expo, and Supabase
5. **Review recent changes** that might have introduced issues

## üîÑ Deployment Process

### For Features (develop ‚Üí main)
1. Create feature branch from `develop`
2. Make changes and commit
3. Push to feature branch
4. Create PR to `develop`
5. After review, merge to `develop` (triggers staging deployment)
6. Test on staging environment
7. Create PR from `develop` to `main`
8. After review, merge to `main` (triggers production deployment)

### For Hotfixes (main ‚Üí main)
1. Create hotfix branch from `main`
2. Make critical fixes
3. Create PR to `main`
4. After review, merge to `main` (triggers production deployment)
5. Merge back to `develop` to keep branches in sync

## üìà Performance Optimization

### Build Optimization
- Uses `npm ci` for faster, reliable installs
- Caches Node.js dependencies between runs
- Parallel job execution where possible
- Artifact uploading for build reuse

### Deployment Optimization
- Vercel's edge network for global distribution
- Automatic static optimization
- Image optimization enabled
- Compression and minification

## üîí Security Considerations

### Secret Management
- All sensitive data stored as GitHub secrets
- Environment-specific configurations
- No secrets in code or logs
- Regular secret rotation recommended

### Security Headers
- X-Frame-Options: DENY
- X-Content-Type-Options: nosniff
- X-XSS-Protection: 1; mode=block
- Cache-Control for sensitive endpoints

---

**Last Updated**: [Current Date]
**Pipeline Version**: 1.0
