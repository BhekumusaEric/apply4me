name: Apply4Me CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # Test and Build Web App
  test-web:
    name: ğŸ§ª Test Web Application
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¥ Install dependencies
      run: npm ci

    - name: ğŸ” Run ESLint
      run: npm run lint || echo "Linting completed with warnings"

    - name: ğŸ—ï¸ Build application
      run: npm run build
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
        NEXT_PUBLIC_YOCO_PUBLIC_KEY: ${{ secrets.NEXT_PUBLIC_YOCO_PUBLIC_KEY }}
        YOCO_SECRET_KEY: ${{ secrets.YOCO_SECRET_KEY }}

    - name: ğŸ§ª Run tests
      run: npm test -- --passWithNoTests

    - name: ğŸ“Š Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: web-build
        path: .next/

  # Mobile app testing disabled - focusing on web application
  # test-mobile:
  #   name: ğŸ“± Test Mobile Application
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: ğŸ“¥ Checkout code
  #     uses: actions/checkout@v4

  # Deploy to Staging (Develop Branch)
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    needs: [test-web]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¥ Install Vercel CLI
      run: npm install --global vercel@latest

    - name: ğŸ”— Pull Vercel Environment Information
      run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

    - name: ğŸ—ï¸ Build Project Artifacts
      run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

    - name: ğŸš€ Deploy to Staging
      run: vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }}

  # Deploy to Production (Main Branch)
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    needs: [test-web]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¥ Install Vercel CLI
      run: npm install --global vercel@latest

    - name: ğŸ”— Pull Vercel Environment Information
      run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

    - name: ğŸ—ï¸ Build Project Artifacts
      run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

    - name: ğŸš€ Deploy to Production
      run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}

    - name: ğŸ“§ Notify Success
      if: success()
      run: |
        echo "âœ… Production deployment successful!"
        echo "ğŸŒ Live at: https://apply4me-eta.vercel.app"

  # Mobile app build disabled - focusing on web application
  # build-mobile-android:
  #   name: ğŸ“± Build Android App
  #   needs: [test-web]
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/main'

  # Health Check
  health-check:
    name: ğŸ¥ Health Check
    needs: [deploy-production]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ” Check website health
      run: |
        echo "ğŸ” Checking Apply4Me health..."
        response=$(curl -s -o /dev/null -w "%{http_code}" https://apply4me-eta.vercel.app)
        if [ $response -eq 200 ]; then
          echo "âœ… Website is healthy (HTTP $response)"
        else
          echo "âŒ Website health check failed (HTTP $response)"
          exit 1
        fi

    - name: ğŸ” Check API health
      run: |
        echo "ğŸ” Checking API health..."
        response=$(curl -s -o /dev/null -w "%{http_code}" https://apply4me-eta.vercel.app/api/health)
        if [ $response -eq 200 ]; then
          echo "âœ… API is healthy (HTTP $response)"
        else
          echo "âš ï¸ API health check returned HTTP $response"
        fi
